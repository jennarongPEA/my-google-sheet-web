<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Dashboard - Smart Budget กบล.</title>
    <!-- Load React, Tailwind, Recharts via CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/recharts/umd/Recharts.js"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #0F0518; }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #1A0B2E; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;
        const { 
            BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip: RechartsTooltip, 
            Legend, ResponsiveContainer, Cell, LabelList, PieChart, Pie, Cell as PieCell
        } = Recharts;

        // --- UTILS ---
        const formatCurrency = (value) => new Intl.NumberFormat('th-TH', { maximumFractionDigits: 0 }).format(value);
        const formatK = (value) => {
            if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M';
            if (value >= 1000) return (value / 1000).toFixed(0) + 'k';
            return value;
        };

        const KPI_LEVELS = [
            { level: 5, label: 'ดีมาก', maxPercent: 82.25, color: '#10B981' }, 
            { level: 4, label: 'ดี', maxPercent: 88.16, color: '#84CC16' }, 
            { level: 3, label: 'ปานกลาง', maxPercent: 94.08, color: '#FACC15' }, 
            { level: 2, label: 'พอใช้', maxPercent: 100.00, color: '#F97316' }, 
            { level: 1, label: 'ต้องปรับปรุง', maxPercent: 105.92, color: '#EF4444' }, 
        ];

        const DEPT_COLORS = ['#8B5CF6', '#EC4899', '#F59E0B', '#10B981', '#3B82F6', '#6366F1', '#EF4444'];

        // --- COMPONENTS ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const [iconSvg, setIconSvg] = useState("");
            useEffect(() => {
                if (window.lucide) {
                    const svg = lucide.createIcons();
                }
            }, [name]);
            // ใช้ชื่อไอคอนจาก lucide โดยตรง
            const LucideIcon = lucide[name] || lucide.HelpCircle;
            return <LucideIcon size={size} className={className} />;
        };

        const GaugeChart = ({ percent }) => {
            const safePercent = Math.min(Math.max(percent || 0, 0), 110); 
            const cx = 150; const cy = 150; const iR = 80; const oR = 120; 
            const needleAngle = 180 * (1 - (safePercent / 110)); 
            const thetaRad = (needleAngle * Math.PI) / 180;
            const needleLen = iR - 10;
            const nx = cx + needleLen * Math.cos(thetaRad);
            const ny = cy - needleLen * Math.sin(thetaRad);

            return (
                <div className="relative w-[300px] h-[160px] mx-auto overflow-hidden">
                    <ResponsiveContainer width="100%" height={300}>
                        <PieChart>
                            <Pie
                                dataKey="value" startAngle={180} endAngle={0}
                                data={[
                                    { value: 82.25, color: '#10B981' },
                                    { value: 5.91, color: '#84CC16' },
                                    { value: 5.91, color: '#FACC15' },
                                    { value: 5.91, color: '#F97316' },
                                    { value: 10, color: '#EF4444' },
                                ]}
                                cx="50%" cy="50%" innerRadius={iR} outerRadius={oR}
                            >
                                {[...Array(5)].map((_, i) => (
                                    <PieCell key={i} fill={['#10B981', '#84CC16', '#FACC15', '#F97316', '#EF4444'][i]} stroke="none" />
                                ))}
                            </Pie>
                        </PieChart>
                    </ResponsiveContainer>
                    <svg className="absolute top-0 left-0 w-full h-full pointer-events-none">
                        <line x1={cx} y1={cy} x2={nx} y2={ny} stroke="white" strokeWidth="4" strokeLinecap="round" />
                        <circle cx={cx} cy={cy} r="6" fill="white" />
                        <text x={cx} y={cy - 20} textAnchor="middle" fill="white" fontSize="24" fontWeight="bold">{safePercent.toFixed(2)}%</text>
                        <text x={cx} y={cy + 20} textAnchor="middle" fill="#94a3b8" fontSize="12">การเบิกจ่ายจริง</text>
                    </svg>
                </div>
            );
        };

        // --- MAIN APP ---
        function App() {
            const [activeTab, setActiveTab] = useState('overview1');
            const [sidebarOpen, setSidebarOpen] = useState(true);
            const [sheetData, setSheetData] = useState([]);
            const [loading, setLoading] = useState(true);

            const API_URL = "https://script.google.com/macros/s/AKfycby8D83VHt6lAqb3ETNFSsP88A2IdG5qVUHZkWGcnAXwMha_BifBje9UTR4xIre7BBZE/exec";

            useEffect(() => {
                fetch(API_URL)
                    .then(res => res.json())
                    .then(data => {
                        setSheetData(data);
                        setLoading(false);
                        setTimeout(() => lucide.createIcons(), 100);
                    })
                    .catch(err => console.error("Fetch Error:", err));
            }, []);

            if (loading) return (
                <div className="min-h-screen bg-[#0F0518] flex flex-col items-center justify-center text-white">
                    <div className="w-12 h-12 border-4 border-amber-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                    <p className="animate-pulse">กำลังโหลดข้อมูลจาก Google Sheets...</p>
                </div>
            );

            // Mock สรุปผล (ในอนาคตคุณสามารถคำนวณจาก sheetData ได้)
            const summary = { budget: 2676700, actual: 1411673, percent: 52.74 };

            return (
                <div className="min-h-screen flex bg-[#0F0518] text-slate-200 overflow-hidden">
                    {/* Sidebar */}
                    <aside className={`transition-all duration-300 bg-[#1A0B2E] border-r border-white/10 ${sidebarOpen ? 'w-72' : 'w-20'}`}>
                        <div className="p-4 flex items-center gap-3">
                            <div className="bg-amber-500 p-2 rounded-lg text-black"><lucide.Wallet size={20}/></div>
                            {sidebarOpen && <h1 className="font-bold text-amber-400">Smart Budget กบล.</h1>}
                        </div>
                        <nav className="p-4 space-y-2">
                            <button onClick={() => setActiveTab('overview1')} className={`w-full flex items-center gap-3 p-3 rounded-xl ${activeTab==='overview1'?'bg-purple-900/50 text-white':'hover:bg-white/5'}`}>
                                <lucide.LayoutDashboard size={20}/> {sidebarOpen && "ภาพรวมงบประมาณ"}
                            </button>
                            <button onClick={() => setActiveTab('table')} className={`w-full flex items-center gap-3 p-3 rounded-xl ${activeTab==='table'?'bg-purple-900/50 text-white':'hover:bg-white/5'}`}>
                                <lucide.FileText size={20}/> {sidebarOpen && "ข้อมูลจาก Sheet"}
                            </button>
                        </nav>
                    </aside>

                    {/* Main Content */}
                    <main className="flex-1 p-8 overflow-y-auto h-screen">
                        <header className="mb-8 flex justify-between items-end">
                            <div>
                                <h2 className="text-3xl font-bold">Dashboard</h2>
                                <p className="text-slate-400">เชื่อมต่อข้อมูลแบบ Real-time จาก Google Sheets</p>
                            </div>
                            <div className="flex items-center gap-2 bg-purple-900/30 px-4 py-2 rounded-full border border-purple-500/30 text-purple-300 text-sm">
                                <lucide.Calendar size={16}/> มกราคม 2568
                            </div>
                        </header>

                        {activeTab === 'overview1' ? (
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                <div className="bg-gradient-to-br from-[#2E1065] to-[#1A0B2E] p-8 rounded-2xl border border-amber-500/20">
                                    <p className="text-slate-400">งบประมาณตั้งต้น</p>
                                    <h3 className="text-3xl font-bold font-mono text-white">{formatCurrency(summary.budget)}</h3>
                                    <p className="text-slate-400 mt-4">เบิกจ่ายจริง</p>
                                    <h3 className="text-4xl font-bold font-mono text-amber-400">{formatCurrency(summary.actual)}</h3>
                                </div>
                                <div className="lg:col-span-2 bg-[#150F25] p-8 rounded-2xl border border-white/5 text-center">
                                    <h3 className="text-xl font-bold mb-4">KPI Gauge</h3>
                                    <GaugeChart percent={summary.percent} />
                                </div>
                            </div>
                        ) : (
                            <div className="bg-[#150F25] rounded-2xl border border-white/10 overflow-hidden">
                                <table className="w-full text-left">
                                    <thead className="bg-[#1A0B2E] text-slate-400 text-sm uppercase">
                                        <tr>
                                            <th className="p-4">ลำดับ</th>
                                            {sheetData.length > 0 && Object.keys(sheetData[0]).map(key => (
                                                <th key={key} className="p-4">{key}</th>
                                            ))}
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-white/5">
                                        {sheetData.map((row, idx) => (
                                            <tr key={idx} className="hover:bg-white/5">
                                                <td className="p-4 text-slate-500">{idx + 1}</td>
                                                {Object.values(row).map((val, i) => (
                                                    <td key={i} className="p-4">{val}</td>
                                                ))}
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
